<template>
  <view class="_m_register _hideScrollbar">
    <view class="right-box">
      <view class="title">
        <view>注册</view>
        <img
          src="https://oss.mytrol.cn/uni_mytrol/img/login/title.png"
          alt=""
        />
      </view>
      <view class="input-box">
        <view class="input-phone _m_inp">
          <view class="_span">手机号码</view>
          <input
            type="number"
            maxlength="11"
            v-model="data.ipone"
            name=""
            placeholder="请输入手机号码"
            id=""
            @change="
              (val) => {
                return changeVal('ipone', val);
              }
            "
          />

          <img
            v-if="data.isIpone"
            src="https://oss.mytrol.cn/uni_mytrol/img/login/success.png"
            class="icon"
            alt=""
          />
          <img
            v-else
            src="https://oss.mytrol.cn/uni_mytrol/img/login/failed.png"
            class="icon"
            alt=""
          />
        </view>
        <view class="input-phone _m_inp">
          <view class="_span">短信验证码</view>
          <input
            type="number"
            v-model="data.code"
            placeholder="请输入短信验证码"
            maxlength="6"
            @change="
              (val) => {
                return changeVal('ipone', val);
              }
            "
          />
          <view
            class="verifey-code"
            :style="data.hasClick ? 'color:#c7c7c7;' : ''"
            v-bind:disabled="data.hasClick"
            @click="getCode"
            >{{ data.getCodeTxt }}</view
          >
        </view>
        <view class="input-phone _m_inp">
          <view class="_span">设置密码</view>
          <img
            src="https://oss.mytrol.cn/uni_mytrol/img/login/waring.png"
            class="icon waring"
          />
          <input
            v-model="data.password"
            placeholder="含有数字、大写字母、小写字母、特殊字符中"
            type="password"
            maxlength="18"
            @change="
              (val) => {
                return changeVal('ipone', val);
              }
            "
          />
        </view>
        <view class="input-phone _m_inp">
          <view class="_span">确定密码</view>
          <input
            v-model="data.password2"
            placeholder="请再次输入密码"
            type="password"
            maxlength="18"
            @change="
              (val) => {
                return changeVal('ipone', val);
              }
            "
          />
        </view>
        <!-- <view class="input-phone _m_inp">
          <view class="_span">邀请码</view>
          <input
            :disabled="isCode"
            v-model="data.InvitationCode"
            placeholder="请输入邀请码(选填)"
            maxlength="8"
            @change="
              (val) => {
                return changeVal('ipone', val);
              }
            "
          />
        </view> -->
        <view class="footer">
          <view class="registered">
            <view>已经有账号?&nbsp;&nbsp;请</view>
            <view @click="handleLoginClick">登录</view>
          </view>
        </view>
      </view>
      <view class="btn">
        <!-- <view class="checkbox">
					<input type="checkbox" v-model="data.isUserDoc" />

					<view> 我已阅读并同意 </view>
					<view>《用户协议》和《隐私条款》</view>
				</view> -->
        <view class="registerBtn" @click="login">注册</view>
      </view>
    </view>
    <!-- <view class="mask" v-show="isVerification === 1">
      <PuzzleVerification
        @clone="verifyResult"
        :onSuccess="verifyResult"
        :verificationShow="isVerification"
      />
	  
	  
	  
	  
	  
	  
    </view> -->
  </view>
</template>
<script>
import rules from "@/static/js/rules.js";
import { setStore, getStore } from "../../static/js/global.js";
export default {
  components: {
    // PuzzleVerification,
  },
  data() {
    return {
      isVerification: 0,
      data: {
        ipone: "",
        password: "",
        password2: "",
        code: "",
        InvitationCode: "",

        isIpone: true,
        isPassword: true,
        isPassword2: true,
        isCode: true,
        hasClick: false,
        getCodeTxt: "获取验证码",
        isUserDoc: true,
      },
    };
  },
  methods: {
    setmessage(type = "error", text) {
      uni.showToast({
        title: text,
        duration: 5000,
        icon: "none",
      });
    },
    handleRouterClick(path, type = false) {
      this.$router.push(path);
    },
    // 单个表单验证
    verify_value(key) {
      switch (key) {
        case "ipone":
          return rules.FormValidate.Form().validatePhone(
            "",
            this.data.ipone,
            (error) => {
              return error ? error.message : false;
            }
          );
          break;
        case "password":
          return rules.FormValidate.Form().validatePsdReg(
            "",
            this.data.password,
            (error) => {
              return error ? error.message : false;
            }
          );
        case "password2":
          if (!this.data.password2) {
            return "请再次输入密码";
          }
          return this.data.password == this.data.password2
            ? undefined
            : "两次密码不一致";
          break;

        default:
          break;
      }
    },
    verify_form() {
      if (!this.data.isUserDoc) {
        this.setmessage("error", "请先勾选用户协议和隐私政策");
        return false;
      }
      let verify_ipone = this.verify_value("ipone");
      if (verify_ipone) {
        this.setmessage("error", verify_ipone);
        this.data.isIpone = false;
        return false;
      }

      let verify_password = this.verify_value("password");
      if (verify_password) {
        this.setmessage("error", verify_password);
        this.data.isPassword = false;
        return false;
      }

      let verify_password2 = this.verify_value("password2");
      if (verify_password2) {
        setmessage("error", verify_password2);
        this.data.isPassword2 = false;
        return false;
      }
      return true;
    },
    initDataParams() {
      const data = {
        ipone: "",
        password: "",
        password2: "",
        code: "",
        InvitationCode: "",

        isIpone: true,
        isPassword: true,
        isPassword2: true,
        isCode: true,
        hasClick: false,
        getCodeTxt: "获取验证码",
        isUserDoc: true,
      };
      this.data = data;
    },
    async login() {
      this.data = data;
      if (this.verify_form()) {
        let res = await this.$api._post("/dbchain/oracle/nft/register", {
          phone_number: this.data.ipone,
          password: this.data.password,
          verification_code: this.data.code,
          // invitation_code: this.data.InvitationCode,
        });
        if (res.data.err_code == "0") {
          uni.showToast({
            title: "注册成功，请登录",
            duration: 5000,
            icon: "none",
          });
          this.initDataParams();
          return this.handleRouterClick("/pages/login/login");
        }
      }
    },
    //
    // 获取验证码
    async getCode() {
      let verify_ipone = this.verify_value("ipone");
      if (verify_ipone) {
        this.setmessage("error", verify_ipone);
        this.data.isIpone = false;
        return false;
      }

      this.data.hasClick = true;

      let result = "Success";
      let time = new Date().getTime();
      result = await this.$api._get(
        "/dbchain/oracle/nft/send_verf_code/register/" + this.data.ipone
      );
      if (result.data.err_code !== "0" && result.data.result !== "Success") {
        this.data.getCodeTxt = "重新获取";
        this.data.hasClick = false;
        return;
      }
      this.setmessage("success", "短信验证码已发送");

      //  this.hasClick = false;
      let wait = 60;
      this.data.getCodeTxt = "60";
      let timer = setInterval(() => {
        if (wait > 0) {
          wait--;
          this.data.getCodeTxt = wait + "S";
          this.data.hasClick = true;
        } else {
          this.data.getCodeTxt = "重新获取";
          this.data.hasClick = false;
          wait = 60;
          clearInterval(timer);
        }
      }, 1000);
    },

    //
    changeVal(key, val) {
      switch (key) {
        case "ipone":
          if (verify_value(key)) {
            this.data.isIpone = false;
          } else {
            this.data.isIpone = true;
          }
          break;
        case "password":
          if (verify_value(key)) {
            this.data.isPassword = false;
          } else {
            this.data.isPassword = true;
          }
          break;
        default:
          break;
      }
    },
    verifyResult(type, result) {
      if (type == "admin") {
        this.isVerification = 1;
      } else if (type === "slider") {
        this.isVerification = 0;
      }
    },
    handleLoginClick() {
      this.$router.push("/pages/login/login");
    },
  },
};
</script>
<style lang="scss" scoped>
._m_register {
  display: flex;
  width: 100%;
  height: 100%;

  .right-box {
    width: 100%;
    height: 100%;
    margin-top: 46px;
    padding-left: 12px;
    padding-right: 12px;

    .title {
      display: flex;
      text-align: center;
      align-items: center;
      justify-content: center;

      view {
        width: 60px;
        height: 46px;
        font-size: 30px;
        font-family: SourceHanSansCN-Medium, SourceHanSansCN SC;
      }
    }

    .input-box {
      margin-top: 47px;

      .input-phone {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        margin-bottom: 26px;
        position: relative;

        .icon {
          right: 5px;
          top: 30px;
          transform: translateY(-10%);
          position: absolute;
          width: 26px;
          height: 26px;
          border-radius: 4px;
          text-align: center;
        }

        .waring {
          cursor: pointer;
        }

        .verifey-code {
          position: absolute;
          right: 10px !important;
          top: 32px;
          transform: translateY(-10%);
          cursor: pointer;
          color: #ff451dff;
          font-weight: 600;
          left: unset;
          z-index: 99;
        }

        span {
          height: 26px;
          font-size: 16px;
          font-family: SourceHanSansCN-Regular, SourceHanSansCN SC;
          font-weight: 400;
          color: #ff451d;
          line-height: 26px;
          position: absolute;
          top: -14px;
          z-index: 1;
          background: #fff;
          left: 13px;
        }

        input {
          font-size: 18px;
          margin-top: 20px;
          // font-size: 12px;
          width: 100%;
          padding-bottom: 2px;
          border-bottom: 2px solid #cacaca;

          &:focus {
            border-bottom-color: #ff451dff;
          }
        }
      }

      .footer {
        display: flex;
        justify-content: flex-end;

        .registered {
          text-align: right;
          width: 30%;
          min-width: 169px;
          font-size: 14px;
          font-family: SourceHanSansCN-Regular, SourceHanSansCN SC;
          font-weight: 400;
          color: #000000;
          display: flex;
          justify-content: flex-end;
          view:nth-child(2) {
            color: #ff451d;
            font-weight: 600;
            cursor: pointer;
          }
        }
      }
    }
  }

  .btn {
    width: 100%;
    margin-top: 57px;
    padding-bottom: 38px;

    .checkbox {
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      font-size: 16px;
      font-weight: 600;
      color: #000000;
      font-size: 14px;
      font-family: SourceHanSansCN-Regular, SourceHanSansCN SC;
      font-weight: 400;
      color: #000000;
      line-height: 20px;

      input {
        cursor: pointer;
      }

      view:nth-of-type(2) {
        cursor: pointer;
        color: #ff451dff;
      }
    }

    .registerBtn {
      cursor: pointer;
      width: 100%;
      font-size: 20px;
      color: #ffffff;
      text-align: center;
      height: 58px;
      line-height: 58px;
      background: #2f0088;
      border-radius: 6px;
      background: linear-gradient(270deg, #ff451d 0%, #ffca2a 100%);
    }
  }

  .mask {
    width: 100%;
    height: 100%;
    position: fixed;
    top: 0;
    left: 0;
    background: rgba(242, 242, 242, 0.7);
  }
}
</style>
